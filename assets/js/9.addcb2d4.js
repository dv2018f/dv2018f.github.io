(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{733:function(s,n,e){s.exports=e.p+"assets/img/image-20230331220454586-1692265484651.bffd1b5f.png"},734:function(s,n,e){s.exports=e.p+"assets/img/image2023-4-4_14-13-47.21e97c4a.png"},735:function(s,n,e){s.exports=e.p+"assets/img/image2023-4-4_14-11-9.abb29c3f.png"},736:function(s,n,e){s.exports=e.p+"assets/img/image2023-4-10_10-54-5.ad30c73c.png"},737:function(s,n,e){s.exports=e.p+"assets/img/image2023-4-10_16-41-17.a29e66b3.png"},738:function(s,n,e){s.exports=e.p+"assets/img/image2023-4-3_14-49-30.a7d4ec47.png"},739:function(s,n,e){s.exports=e.p+"assets/img/image2023-4-3_16-55-24.1fdf4a0a.png"},740:function(s,n,e){s.exports=e.p+"assets/img/image2023-4-11_18-3-38.b44a4050.png"},741:function(s,n,e){s.exports=e.p+"assets/img/image2023-4-3_18-15-18.80643006.png"},772:function(s,n,e){"use strict";e.r(n);var a=e(5),r=Object(a.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("概要")]),s._v(" "),a("p",[s._v("工作报告模块，经常性Mysql 慢日志告警，分析工作报告业务，并根据现有的表进行SQL 优化。")])]),s._v(" "),a("h2",{attrs:{id:"一、慢sql分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、慢sql分析"}},[s._v("#")]),s._v(" 一、慢SQL分析")]),s._v(" "),a("h3",{attrs:{id:"_1-1-当前慢sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-当前慢sql"}},[s._v("#")]),s._v(" 1.1 当前慢SQL")]),s._v(" "),a("p",[a("strong",[s._v("现状慢SQL: t_work_report_record和t_work_report_receive连表扫描行数远超notice查询, 通知查询容易受影响。观察告警日志，慢SQL 查询围绕 ：1. 工作报告通知 2.工作报告查询两个模块")])]),s._v(" "),a("p",[s._v("截止到"),a("strong",[s._v("2023-04-11")]),s._v("所有的慢查询：tapd : https://www.tapd.cn/20013741/prong/stories/view/1120013741001095865")]),s._v(" "),a("div",{staticClass:"language-Mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-- 慢查询----------------------------------工作报告通知--------------------------------------------------------------\n【生产环境】【mysql慢日志 或 SQL没有使用索引】【查看个人消息通知（查询过去180天,type =3）】\n /*app=crm-work-report*/\nSELECT\n    count(*)\nFROM\n    d_ec_crmextend\n    .\n    t_work_report_notice\nWHERE\n    f_corp_id = 7416431\n    AND (f_user_id = 8352852 )\n    AND f_type = 3\n    AND f_create_time > '2022-09-30 19:21:04'\n \nmysql实例名 = cdb-crm7\n数据库名 = d_ec_crm\n查询时间 = 2.236175 秒\n记录锁定时间 = 2.1E-5 秒\n读取行数 = 24912\nMD5 = 0DA94DB20A517A51\n \n【生产环境】【mysql慢日志 或 SQL没有使用索引】【工作报告首页汇总(固定汇报对象自定义才展示且汇报对象包含当前userId)workreport/list/summary  查询通知type = 7的汇总消息】\n /*app=crm-work-report*/\nSELECT\n    f_id\n    AS id,\n    f_content AS content,\n    f_template_id AS templateId,\n    f_create_time AS createTime\nFROM\n    d_ec_crmextend\n    .\n    t_work_report_notice\nWHERE\n    f_corp_id = 7416431\n    AND f_user_id = 8352852\n    AND f_type = 7\n    AND f_create_time BETWEEN '2023-04-03 20:06:18' AND '2023-04-10 20:06:18'\n    and f_notice_type = 0\n \nmysql实例名 = cdb-crm7\n数据库名 = d_ec_crm\n查询时间 = 2.120368 秒\n     \n         \n【生产环境】【mysql慢日志 或 SQL没有使用索引】【提醒列表：当前用户提醒总数-ios端用到（安卓端、桌面端、pc端未使用）,可能不需要该count】\nselect\n    count(*)\nfrom\n    d_ec_crmextend\n    .\n    t_work_report_notice\nwhere\n    f_corp_id = 7416431\n    and f_user_id = 8352852\n    and f_notice_type = 0\nmysql实例名 = cdb-crm7\n数据库名 = d_ec_crm\n查询时间 = 2.091448 秒\n记录锁定时间 = 1.7E-5 秒\n读取行数 = 24930\nMD5 = DD1ABC1656C9C674\n \n     \n-- 慢查询----------------------------------工作报告查询---------------------------------------  \n【生产环境】【mysql慢日志 或 SQL没有使用索引】【tab页 我收到的报告总数】\nSELECT\n    count(distinct r.f_report_id)\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nLEFT JOIN d_ec_crmextend.t_work_report_receive AS\n    e\n    ON\n    r.f_report_id = e.f_report_id\nWHERE\n    r.f_corp_id = 7416431\n    AND e.f_corp_id = 7416431\n    AND e.f_receive_user_id IN\n         (8352852)\n    AND r.f_create_time >= '2023-03-15 00:00:00'\n    AND r.f_create_time <= '2023-03-15 23:59:59'\n \nmysql实例名 = cdb-crm7\n数据库名 = d_ec_crm\n查询时间 = 2.217934 秒\n记录锁定时间 = 2.5E-5 秒\n读取行数 = 64840\nMD5 = C4D5D4A8BA9D3164\n \n \n \n【生产环境】【mysql慢日志 或 SQL没有使用索引】【tab页 我收到的报告记录】\n /*app=crm-work-report*/\nSELECT\n    r.f_report_id AS reportId,\n    r.f_corp_id AS corpId,\n    r.f_user_id AS userId,\n    r.f_type AS\n    type,\n    r.f_template_id AS templateId,\n    r.f_template_title AS templateTitle,\n    r.f_attach_num AS attachNum,\n    r.f_comment_num AS commentNum,\n    r.f_create_time AS\n    createTime,\n    r.f_update_time AS updateTime,\n    e.f_is_read AS isRead\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nLEFT JOIN d_ec_crmextend.t_work_report_receive AS\n    e\n    ON\n    r.f_report_id = e.f_report_id\nWHERE\n    r.f_corp_id = 7416431\n    AND e.f_corp_id = 7416431\n    AND e.f_receive_user_id IN\n         (8352852)\nGROUP BY\n    r.f_report_id\nORDER BY\n    r.f_create_time DESC\nLIMIT 0,\n50\n \nmysql实例名 = cdb-crm7\n数据库名 = d_ec_crm\n查询时间 = 2.069463 秒\n记录锁定时间 = 1.9E-5 秒\n读取行数 = 419883\nMD5 = 479AEB349F5BF9F8\n \n \n【生产环境】【mysql慢日志 或 SQL没有使用索引】【pc端查看模板所有提交报告总数\nSELECT\n    count(distinct r.f_report_id)\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nLEFT JOIN d_ec_crmextend.t_work_report_receive AS\n    e\n    ON\n    r.f_report_id = e.f_report_id\nWHERE\n    r.f_corp_id = 12219010\n    AND e.f_corp_id = 12219010\n    AND r.f_template_id = 549\n \nmysql实例名 = cdb-crm2\n数据库名 = d_ec_crm\n查询时间 = 4.672249 秒\n记录锁定时间 = 1.8E-5 秒\n读取行数 = 209500\nMD5 = 444A88A0291F9885\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br"),a("span",{staticClass:"line-number"},[s._v("111")]),a("br"),a("span",{staticClass:"line-number"},[s._v("112")]),a("br"),a("span",{staticClass:"line-number"},[s._v("113")]),a("br"),a("span",{staticClass:"line-number"},[s._v("114")]),a("br"),a("span",{staticClass:"line-number"},[s._v("115")]),a("br"),a("span",{staticClass:"line-number"},[s._v("116")]),a("br"),a("span",{staticClass:"line-number"},[s._v("117")]),a("br"),a("span",{staticClass:"line-number"},[s._v("118")]),a("br"),a("span",{staticClass:"line-number"},[s._v("119")]),a("br"),a("span",{staticClass:"line-number"},[s._v("120")]),a("br"),a("span",{staticClass:"line-number"},[s._v("121")]),a("br"),a("span",{staticClass:"line-number"},[s._v("122")]),a("br"),a("span",{staticClass:"line-number"},[s._v("123")]),a("br"),a("span",{staticClass:"line-number"},[s._v("124")]),a("br"),a("span",{staticClass:"line-number"},[s._v("125")]),a("br"),a("span",{staticClass:"line-number"},[s._v("126")]),a("br"),a("span",{staticClass:"line-number"},[s._v("127")]),a("br"),a("span",{staticClass:"line-number"},[s._v("128")]),a("br"),a("span",{staticClass:"line-number"},[s._v("129")]),a("br"),a("span",{staticClass:"line-number"},[s._v("130")]),a("br"),a("span",{staticClass:"line-number"},[s._v("131")]),a("br"),a("span",{staticClass:"line-number"},[s._v("132")]),a("br"),a("span",{staticClass:"line-number"},[s._v("133")]),a("br"),a("span",{staticClass:"line-number"},[s._v("134")]),a("br"),a("span",{staticClass:"line-number"},[s._v("135")]),a("br"),a("span",{staticClass:"line-number"},[s._v("136")]),a("br"),a("span",{staticClass:"line-number"},[s._v("137")]),a("br"),a("span",{staticClass:"line-number"},[s._v("138")]),a("br"),a("span",{staticClass:"line-number"},[s._v("139")]),a("br"),a("span",{staticClass:"line-number"},[s._v("140")]),a("br"),a("span",{staticClass:"line-number"},[s._v("141")]),a("br"),a("span",{staticClass:"line-number"},[s._v("142")]),a("br"),a("span",{staticClass:"line-number"},[s._v("143")]),a("br"),a("span",{staticClass:"line-number"},[s._v("144")]),a("br"),a("span",{staticClass:"line-number"},[s._v("145")]),a("br"),a("span",{staticClass:"line-number"},[s._v("146")]),a("br"),a("span",{staticClass:"line-number"},[s._v("147")]),a("br"),a("span",{staticClass:"line-number"},[s._v("148")]),a("br"),a("span",{staticClass:"line-number"},[s._v("149")]),a("br"),a("span",{staticClass:"line-number"},[s._v("150")]),a("br"),a("span",{staticClass:"line-number"},[s._v("151")]),a("br"),a("span",{staticClass:"line-number"},[s._v("152")]),a("br"),a("span",{staticClass:"line-number"},[s._v("153")]),a("br"),a("span",{staticClass:"line-number"},[s._v("154")]),a("br")])]),a("h3",{attrs:{id:"_1-2-监控数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-监控数据"}},[s._v("#")]),s._v(" 1.2 监控数据")]),s._v(" "),a("p",[a("img",{attrs:{src:e(733),alt:"image-20230331220454586"}})]),s._v(" "),a("p",[a("img",{attrs:{src:e(734),alt:"image2023-4-4_14-13-47"}})]),s._v(" "),a("p",[a("img",{attrs:{src:e(735),alt:"image2023-4-4_14-11-9"}})]),s._v(" "),a("h3",{attrs:{id:"_1-3-分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-分析"}},[s._v("#")]),s._v(" 1.3 分析")]),s._v(" "),a("p",[s._v("​        监控数据：查看慢SQL 出现的时间 innoDB IO 读写次数有明显的突刺现象，IO读写量慢查询为 66Mb/s， IO读写次数达4052次/s， IO负载很高。除去cpu计算的10ms-20ms和其他业务平均IO次数等，结合查询总耗时估算出IO一次是1ms左右（还包含了其他操作的耗时，写内存也有一定耗时，操作bufferpool也有一定耗时，总体来说一次io是1ms内）, 所以结合工作报告的业务降低IO读写次数是优化的一个大方向。")]),s._v(" "),a("h2",{attrs:{id:"二、慢sql-解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、慢sql-解决方案"}},[s._v("#")]),s._v(" 二、慢SQL 解决方案")]),s._v(" "),a("h3",{attrs:{id:"_1-pv-app-我提交的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-pv-app-我提交的"}},[s._v("#")]),s._v(" 1 PV/APP 我提交的")]),s._v(" "),a("h4",{attrs:{id:"_1-1-慢sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-慢sql"}},[s._v("#")]),s._v(" 1.1 慢SQL")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\ncount(distinct r.f_report_id)\nFROM\nd_ec_crmextend.t_work_report_record AS r\nLEFT JOIN\nd_ec_crmextend.t_work_report_receive AS e ON r.f_report_id = e.f_report_id\nWHERE\nr.f_corp_id = 7416431\nAND e.f_corp_id = 7416431\nAND r.f_user_id IN (8352852)\n-- 时间可选 模板id可选\n-- AND r.f_template_id = #{templateId}\n-- AND r.f_create_time >= '2023-03-01 00:00:00'\n-- AND r.f_create_time <= '2023-03-31 23:59:59'\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\n    r.f_report_id AS reportId,\n    r.f_corp_id AS corpId,\n    r.f_user_id AS userId,\n    r.f_type AS type,\n    r.f_template_id AS templateId,\n    r.f_template_title AS templateTitle,\n    r.f_attach_num AS attachNum,\n    r.f_comment_num AS commentNum,\n    r.f_create_time AS createTime,\n    r.f_update_time AS updateTime,\n    e.f_is_read AS isRead\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nLEFT JOIN\n        d_ec_crmextend.t_work_report_receive AS e \n            ON\n    r.f_report_id = e.f_report_id\nWHERE\n    r.f_corp_id = 7416431\n    AND e.f_corp_id = 7416431\n    AND r.f_user_id IN (8352852)\n    --  时间可选 模板id可选\n    -- AND r.f_template_id = #{templateId}\n    -- AND r.f_create_time >= '2023-03-01 00:00:00'\n    -- AND r.f_create_time <= '2023-03-31 23:59:59'\nGROUP BY\n    r.f_report_id\nORDER BY\n    r.f_create_time DESC\nLIMIT 0,50;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[s._v("查看explain结果：连表查询且 "),a("strong",[s._v("采用Using temporary：使用了临时表保存中间结果，性能特别差，需要重点优化，而且还使用了Using filesort 额外的文件排序")])]),s._v(" "),a("p",[a("img",{attrs:{src:e(736),alt:"image2023-4-10_10-54-5"}})]),s._v(" "),a("h4",{attrs:{id:"_1-2-优化建议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-优化建议"}},[s._v("#")]),s._v(" 1.2 优化建议")]),s._v(" "),a("p",[s._v("​      查询报告列表去除is_read(因为这个is_read 没有使用到且gropy by取出来的is_read不准) 和连表，而且查询的总数中并不需要连表查询，所以可以单独拆开。 查询我提交的工作报告页面中采用了分页，因为用户90%以上都是查询第一页，所以暂时还未处理深分页的问题。此处筛选时间(排序)是比较高频的操作，虽templateId 区分度 并不是很高，但如果加入corp_user_time_idx("),a("code",[s._v("f_corp_id")]),s._v(","),a("code",[s._v("f_user_id")]),s._v(","),a("code",[s._v("f_create_time")]),s._v(") 索引，回和单独的templateId 组成index_merge 即 Using intersect(idx_corp_user,idx_template);")]),s._v(" "),a("p",[s._v("可以在表t_work_report_record增加一个时间的联合索引 即corp_user_time_template_idx("),a("code",[s._v("f_corp_id")]),s._v(","),a("code",[s._v("f_user_id")]),s._v(","),a("code",[s._v("f_create_time")]),s._v("，"),a("code",[s._v("f_template_id")]),s._v(")")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\n SELECT\n    count(r.f_report_id)\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nwhere\n    r.f_corp_id = 7416431\n    AND r.f_user_id = '8352852'\n    --  时间可选 模板id可选\n    -- AND r.f_template_id = #{templateId}\n    -- AND r.f_create_time >= '2023-03-01 00:00:00'\n    -- AND r.f_create_time <= '2023-03-31 23:59:59'\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\n    r.f_report_id AS reportId,\n    r.f_corp_id AS corpId,\n    r.f_user_id AS userId,\n    r.f_type AS type,\n    r.f_template_id AS templateId,\n    r.f_template_title AS templateTitle,\n    r.f_attach_num AS attachNum,\n    r.f_comment_num AS commentNum,\n    r.f_create_time AS createTime,\n    r.f_update_time AS updateTime\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nWHERE\n    r.f_corp_id = 7416431\n    AND r.f_user_id = 8352852\n    --  时间可选 模板id可选\n    -- AND r.f_template_id = #{templateId}\n    -- AND r.f_create_time >= '2023-03-01 00:00:00'\n    -- AND r.f_create_time <= '2023-03-31 23:59:59'\nORDER BY\n    r.f_create_time DESC\nLIMIT 0,50;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("当带上templateId：则产生了索引合并现象type: index_merge，Using intersect(idx_corp_user,idx_template); Using where; Using filesort，索引合并templateId 索引树过滤性比较差，一样需要很多磁盘IO, 意味着我们的索引建立得不太合理 ， 查看当前templateId 字段作为单独的索引。")]),s._v(" "),a("p",[s._v("小总结：改造主要是围绕连表改单表二次查询方向，且增加时间("),a("strong",[s._v("考虑可以增加corpId_userId_createTime_templateId")]),s._v(")作为联合索引。")]),s._v(" "),a("h3",{attrs:{id:"_2-tab页我收到的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-tab页我收到的"}},[s._v("#")]),s._v(" 2 tab页我收到的")]),s._v(" "),a("h4",{attrs:{id:"_1-1-慢sql-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-慢sql-2"}},[s._v("#")]),s._v(" 1.1 慢SQL")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\n    count(distinct r.f_report_id)\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nLEFT JOIN\n        d_ec_crmextend.t_work_report_receive AS e \n            ON\n    r.f_report_id = e.f_report_id\nWHERE\n    r.f_corp_id = 7416431\n    AND e.f_corp_id = 7416431\n    -- AND r.f_user_id IN (- 8352852 -) \n    AND e.f_receive_user_id IN (8352852)\n    AND r.f_create_time >= '2023-03-27 00:00:00'\n    AND r.f_create_time <= '2023-04-03 23:59:59';\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\n    r.f_report_id AS reportId,\n    r.f_corp_id AS corpId,\n    r.f_user_id AS userId,\n    r.f_type AS type,\n    r.f_template_id AS templateId,\n    r.f_template_title AS templateTitle,\n    r.f_attach_num AS attachNum,\n    r.f_comment_num AS commentNum,\n    r.f_create_time AS createTime,\n    r.f_update_time AS updateTime,\n    e.f_is_read AS isRead\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nLEFT JOIN\n        d_ec_crmextend.t_work_report_receive AS e \n            ON\n    r.f_report_id = e.f_report_id\nWHERE\n    r.f_corp_id = 7416431\n    AND e.f_corp_id = 7416431\n    AND e.f_receive_user_id IN (8352852)\n    AND r.f_create_time >= '2023-03-02 00:00:00'\n    AND r.f_create_time <= '2023-04-03 23:59:59'\nGROUP BY\n    r.f_report_id\nORDER BY\n    r.f_create_time DESC\nLIMIT 0,50;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("p",[a("img",{attrs:{src:e(737),alt:"image2023-4-10_16-41-17"}})]),s._v(" "),a("h4",{attrs:{id:"_1-2-优化建议-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-优化建议-2"}},[s._v("#")]),s._v(" 1.2 优化建议")]),s._v(" "),a("p",[s._v("查询报告列表使用了连表，而且查询的总数中并不需要连表查询，所以可以单独拆开。可以改成单独对"),a("strong",[s._v("t_work_report_receive")]),s._v("表进行查询，其他分析和我提交的tab页类似，此处筛选时间(排序)是比较高频的操作 ， "),a("strong",[s._v("可以在表t_work_report_receive增加一个时间的联合索引 即corp_user_time_idx("),a("code",[s._v("f_corp_id")]),s._v(","),a("code",[s._v("f_receive_user_id")]),s._v(","),a("code",[s._v("f_create_time")]),s._v(")")]),s._v("。")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\n        count(r.f_report_id) \n    FROM\n        d_ec_crmextend.t_work_report_receive AS r \n    WHERE\n        r.f_corp_id = 7416431 \n        -- AND r.f_user_id IN (- 8352852 -) \n        AND r.f_receive_user_id = '8352852'\n        AND r.f_create_time >= '2023-03-27 00:00:00' \n        AND r.f_create_time <= '2023-04-03 23:59:59';\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-- 第一条查询我收到的报告id\nEXPLAIN\nSELECT\n    e.f_report_id AS reportId,\n    e.f_is_read AS isRead\nFROM d_ec_crmextend.t_work_report_receive AS e    \nWHERE\n     e.f_corp_id = 7416431\n    AND e.f_receive_user_id = 8352852\n    AND e.f_create_time >= '2023-03-02 00:00:00'\n    AND e.f_create_time <= '2023-04-03 23:59:59'\nORDER BY\n    e.f_create_time DESC\nLIMIT 0,50;\n \n \n-- 第二条报告详情\nSELECT\n    r.f_report_id AS reportId,\n    r.f_corp_id AS corpId,\n    r.f_user_id AS userId,\n    r.f_type AS type,\n    r.f_template_id AS templateId,\n    r.f_template_title AS templateTitle,\n    r.f_attach_num AS attachNum,\n    r.f_comment_num AS commentNum,\n    r.f_create_time AS createTime,\n    r.f_update_time AS updateTime\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nwhere\n    `f_report_id` in (\n    2255141, 2255095, 2255080, 2255048,2254978,2254951,2254945,2254835,2254884,\n    2254823, 2254873,2254857,2254856,2254808,2254803,2254801,2254850,2254798,\n    2254842,2254738,2254734,2254778,2254777,2254725,2254774,2254765,2254752,\n    2254749,2254636,2254688,2254618,2254615,2254597,2254591,2254587,2254580,\n    2254538,2254523,2254560,2254519,2254515,2254513,2254509,2254549,2254438,\n    2254436,2254432,2254416,2254413,2254474\n  )\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br")])]),a("h3",{attrs:{id:"_3-首页-统计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-首页-统计"}},[s._v("#")]),s._v(" 3  首页-统计")]),s._v(" "),a("h4",{attrs:{id:"_1-1-慢sql-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-慢sql-3"}},[s._v("#")]),s._v(" 1.1 慢SQL")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-- 首页最近工作报告：未读\nEXPLAIN\nSELECT\n    r.f_report_id AS reportId,\n    r.f_corp_id AS corpId,\n    r.f_user_id AS userId,\n    r.f_type AS type,\n    r.f_template_id AS templateId,\n    r.f_template_title AS templateTitle,\n    r.f_attach_num AS attachNum,\n    r.f_comment_num AS commentNum,\n    r.f_create_time AS createTime,\n    r.f_update_time AS updateTime,\n    e.f_is_read AS isRead\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nLEFT JOIN\n        d_ec_crmextend.t_work_report_receive AS e \n            ON\n    r.f_report_id = e.f_report_id\nWHERE\n    r.f_corp_id = 7416431\n    AND e.f_corp_id = 7416431\n    AND e.f_is_read = 0\n    AND e.f_receive_user_id IN (8352852)\nGROUP BY\n    r.f_report_id\nORDER BY\n    r.f_create_time DESC\nLIMIT 0,50;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("h4",{attrs:{id:"_1-2-优化建议-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-优化建议-3"}},[s._v("#")]),s._v(" 1.2 优化建议")]),s._v(" "),a("p",[s._v("采用拆分方式")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-- 第一条查询我收到的报告id -未读\nEXPLAIN\nSELECT\n    e.f_report_id AS reportId\nFROM d_ec_crmextend.t_work_report_receive AS e    \nWHERE\n     e.f_corp_id = 7416431\n    AND e.f_receive_user_id = 8352852\n    AND e.f_is_read = 0\nORDER BY\n    e.f_create_time DESC\nLIMIT 0,50;\n \n \n-- 第二条报告详情\nSELECT\n    r.f_report_id AS reportId,\n    r.f_corp_id AS corpId,\n    r.f_user_id AS userId,\n    r.f_type AS type,\n    r.f_template_id AS templateId,\n    r.f_template_title AS templateTitle,\n    r.f_attach_num AS attachNum,\n    r.f_comment_num AS commentNum,\n    r.f_create_time AS createTime,\n    r.f_update_time AS updateTime\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nwhere\n    `f_report_id` in (\n    2255141, 2255095, 2255080, 2255048,2254978,2254951,2254945,2254835,2254884,\n    2254823, 2254873,2254857,2254856,2254808,2254803,2254801,2254850,2254798,\n    2254842,2254738,2254734,2254778,2254777,2254725,2254774,2254765,2254752,\n    2254749,2254636,2254688,2254618,2254615,2254597,2254591,2254587,2254580,\n    2254538,2254523,2254560,2254519,2254515,2254513,2254509,2254549,2254438,\n    2254436,2254432,2254416,2254413,2254474\n  )\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("h3",{attrs:{id:"_4-pc端根据模板查询工作报告"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-pc端根据模板查询工作报告"}},[s._v("#")]),s._v(" 4  PC端根据模板查询工作报告")]),s._v(" "),a("h4",{attrs:{id:"_1-1-慢sql-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-慢sql-4"}},[s._v("#")]),s._v(" 1.1 慢SQL")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\n  count(distinct r.f_report_id)\nFROM\n  d_ec_crmextend.t_work_report_record AS r\n  LEFT JOIN d_ec_crmextend.t_work_report_receive AS e ON r.f_report_id = e.f_report_id\nWHERE\n  r.f_corp_id = 7416431\n  AND e.f_corp_id = 7416431\n  AND r.f_template_id = 409                    \n-- AND e.f_is_read = 0                        \n-- AND r.f_user_id IN          ()                         \n-- AND e.f_receive_user_id IN          ()                         \n-- AND r.f_create_time >=                         \n-- AND r.f_create_time  <=\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT\n  r.f_report_id AS reportId,\n  r.f_corp_id AS corpId,\n  r.f_user_id AS userId,\n  r.f_type AS type,\n  r.f_template_id AS templateId,\n  r.f_template_title AS templateTitle,\n  r.f_attach_num AS attachNum,\n  r.f_comment_num AS commentNum,\n  r.f_create_time AS createTime,\n  r.f_update_time AS updateTime,\n  e.f_is_read AS isRead,\n  r.f_content AS content\nFROM\n  d_ec_crmextend.t_work_report_record AS r\n  LEFT JOIN d_ec_crmextend.t_work_report_receive AS e ON r.f_report_id = e.f_report_id\nWHERE\n  r.f_corp_id = 7416431\n  AND e.f_corp_id = 7416431\n  AND r.f_template_id = 409\n  -- AND e.f_is_read = 0                        \n  -- AND r.f_user_id IN          ()                         \n  -- AND e.f_receive_user_id IN          ()                         \n  -- AND r.f_create_time >=                         \n  -- AND r.f_create_time  <=                        \nGROUP BY\n  r.f_report_id\nORDER BY\n  r.f_create_time DESC\nLIMIT\n  0, 20\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h4",{attrs:{id:"_1-2-优化建议-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-优化建议-4"}},[s._v("#")]),s._v(" 1.2 优化建议")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\n        count(distinct r.f_report_id)\n    FROM\n        d_ec_crmextend.t_work_report_receive AS r\n    WHERE\n        r.f_corp_id = 7416431\n        AND r.f_template_id = 409 \n        -- AND r.f_user_id IN (- 8352852 -) \n        -- AND r.f_receive_user_id = '8352852'\n        --  AND r.f_create_time >= '2023-03-27 00:00:00' \n        -- AND r.f_create_time <= '2023-04-03 23:59:59';\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("EXPLAIN\nSELECT\n   -- 未带user_id此处有可能重复，所以需要加上distinct\n    DISTINCT(e.`f_report_id`)  reportId\nFROM d_ec_crmextend.t_work_report_receive AS e    \nWHERE\n     e.f_corp_id = 7416431\n    AND e.f_template_id = 409\n \nORDER BY\n    e.f_create_time DESC\nLIMIT 0,20;\n \n \n-- 第二条报告详情\nSELECT\n    r.f_report_id AS reportId,\n    r.f_corp_id AS corpId,\n    r.f_user_id AS userId,\n    r.f_type AS type,\n    r.f_template_id AS templateId,\n    r.f_template_title AS templateTitle,\n    r.f_attach_num AS attachNum,\n    r.f_comment_num AS commentNum,\n    r.f_create_time AS createTime,\n    r.f_update_time AS updateTime\nFROM\n    d_ec_crmextend.t_work_report_record AS r\nwhere\n    `f_report_id` in\n    (2255141,2255095,2255080,2255048,2254978,2254951,2254945,\n2254835,2254884,2254823,2254873,2254857,2254856,2254808,\n2254803,2254801,2254850,2254798,2254842,2254738)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("p",[s._v("执行结果：")]),s._v(" "),a("p",[a("img",{attrs:{src:e(738),alt:"image2023-4-3_14-49-30"}})]),s._v(" "),a("h3",{attrs:{id:"_5-pv-app查看个人消息通知"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-pv-app查看个人消息通知"}},[s._v("#")]),s._v(" 5  pv/app查看个人消息通知")]),s._v(" "),a("h4",{attrs:{id:"_1-1-慢sql-5"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-慢sql-5"}},[s._v("#")]),s._v(" 1.1 慢SQL")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-- 提醒列表 需要查询总数total 消息类型 1 提醒 2 评论 3 工作报告提交 4 报告汇总\nEXPLAIN\nSELECT\n  count(*)\nFROM\n  d_ec_crmextend.t_work_report_notice\nWHERE\n  f_corp_id = 7416431\n  AND f_user_id = 8352852\n  AND f_type = 3\n  AND f_create_time > '2022-10-05 15:08:57';\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[a("strong",[s._v("但是查看慢SQL 出现的时间 innoDB IO 读写次数有明显的突刺现象，IO读写量两次慢查询分别为 41Mb/s 和 53Mb/s ， IO读写次数达2559次/s 和 3258次/s ， IO已经负载很高。")])]),s._v(" "),a("p",[a("img",{attrs:{src:e(739),alt:"image2023-4-3_16-55-24"}})]),s._v(" "),a("p",[a("strong",[s._v("查看mysql 页内存：")])]),s._v(" "),a("p",[a("img",{attrs:{src:e(740),alt:"image2023-4-11_18-3-38"}})]),s._v(" "),a("p",[a("strong",[s._v("分析：")])]),s._v(" "),a("p",[s._v("1.数据库的性能瓶颈 出现在磁盘IO， 所以这条SQL 需要频繁的把数据loading 到内存然后进行对比 ， 查看下生产数据库中相应的平均占用500B ,")]),s._v(" "),a("p",[s._v("但 crm7 实例中慢查询企业：f_corp_id=7416431 中平均数达到1.2K 左右 ， 一页16k ，16k/1.2K ≈ 13 ，查看上面那条慢SQL执行计划扫描行数46716，IO次数=46716/13≈3594次，和监控的IO读写次数基本符合， 查询IO一次1ms内但次数多，也就比较慢。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("- 通知表t_work_report_notice综合占用内存\n \nselect\n    TABLE_ROWS,\n    concat(round(sum(DATA_LENGTH / 1024), 2), 'KB') as totalSize,\n    concat(round(sum(DATA_LENGTH / 1024), 2), 'KB')/ TABLE_ROWS as recordSize\nfrom\n    information_schema.TABLES\nwhere\n    table_schema = 'd_ec_crmextend'\n    and table_name = 't_work_report_notice';\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[a("img",{attrs:{src:e(741),alt:"image2023-4-3_18-15-18"}})]),s._v(" "),a("h4",{attrs:{id:"_1-2-优化建议-5"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-优化建议-5"}},[s._v("#")]),s._v(" 1.2 优化建议")]),s._v(" "),a("ol",[a("li",[a("p",[a("strong",[s._v("有限的资源的中，增加f_corp_id + f_user_id + f_create_time + f_type 覆盖索引， 按照区分度大小一次排序 ，减少IO次数 收益高")])])]),s._v(" "),a("li",[a("p",[s._v("迁移"),a("strong",[s._v("f_conent,")]),s._v(" "),a("strong",[s._v("f_sale_data_value 两个大")]),s._v("字段 ，平均会降低到 "),a("strong",[s._v("140B（预估值）")]),s._v(" 左右，所以可以考虑单独把占用大的字段"),a("strong",[s._v("f_conent,")]),s._v(" "),a("strong",[s._v("f_sale_data_value")]),s._v(" 移动到另一张表存储("),a("strong",[s._v("已知当前看业务中不需要根据content/sale_value进行模糊查询")]),s._v(")，增加一个外键（索引）值指向t_work_report_notice 表中的f_id")])]),s._v(" "),a("li",[a("p",[s._v("业务考虑是否可以去除该total select count(*)计算")])])]),s._v(" "),a("h4",{attrs:{id:"_1-3-汇总sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-汇总sql"}},[s._v("#")]),s._v(" 1.3 汇总SQL")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-- 提醒列表 查询7天内汇总通知\nEXPLAIN\nSELECT\n  f_id AS id,\n  f_content AS content,\n  f_template_id AS templateId,\n  f_create_time AS createTime\nFROM\n  d_ec_crmextend.t_work_report_notice\nWHERE\n  f_corp_id = 7416431\n  AND f_user_id = 8352852\n  AND f_type = 7\n  AND f_create_time BETWEEN '2023-03-23 19:38:42' AND '2023-03-30 19:38:43'\n  and f_notice_type = 0;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[a("strong",[s._v("优化方案：")])]),s._v(" "),a("p",[s._v("1.按照之前 联合索引 ****f_corp_id + f_user_id + **f_create_time +** f_type****，where 条件后面全走索引，根据id查询相应记录，当前业务job中汇总通知都是f_notice_type = 0的情况即系统消息，f_notice_type=1是我提交的报告情况，所以业务决定可以去掉该条件")]),s._v(" "),a("p",[s._v("2.按照2.5.1 迁移"),a("strong",[s._v("f_conent,")]),s._v(" "),a("strong",[s._v("f_sale_data_value 两个大")]),s._v("字段，一页获取更多的行，再通过f_id 查询到另一张表，即可通过索引查询")]),s._v(" "),a("p",[a("strong",[s._v("综合：针对IO读写次数高的的查询， 优先采用索引覆盖查询，即在表t_work_report_notice中")])]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-- 获取用户通知总数\n【生产环境】【mysql慢日志 或 SQL没有使用索引】【当前用户提醒总数-ios端用到（安卓端、桌面端、pc端未使用）,可能不需要该count】\nselect\n    count(*)\nfrom\n    d_ec_crmextend\n    .\n    t_work_report_notice\nwhere\n    f_corp_id = 7416431\n    and f_user_id = 8352852\n    and f_notice_type = 0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[a("strong",[s._v("优化方案：")])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("该业务是针对IOS 端的旧版本使用，app端一般不用分页，直接下列的模式，考虑业务降级去除select count(*) 统计")])]),s._v(" "),a("li",[a("p",[s._v("按照之前 迁移"),a("strong",[s._v("f_conent,")]),s._v(" "),a("strong",[s._v("f_sale_data_value 两个大")]),s._v("字段，一页获取更多的行，再通过f_id 查询到另一张表，即可通过索引查询。")])])]),s._v(" "),a("h2",{attrs:{id:"三、-其他一些思考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、-其他一些思考"}},[s._v("#")]),s._v(" "),a("strong",[s._v("三、 其他一些思考")])]),s._v(" "),a("h3",{attrs:{id:"_3-1-引入中间组件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-引入中间组件"}},[s._v("#")]),s._v(" "),a("strong",[s._v("3.1 引入中间组件")])]),s._v(" "),a("p",[s._v("1.缓存redis 使用，但工作报告很多是根据当前时间去查询，缓存不可控，也就没命中率")]),s._v(" "),a("p",[s._v("2.ES 工作报告的数据并不是像客户订单等要求非常严谨且响应很快的数据，ES 聚合需要汇报人和接收人一宽表，复杂度高，数据存储性价比非常低")]),s._v(" "),a("h3",{attrs:{id:"_3-2-业务降级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-业务降级"}},[s._v("#")]),s._v(" 3.2 业务降级")]),s._v(" "),a("p",[s._v("1.通知列表中最多只是把查询通知是180天的数据，是不是可以调整业务只查询最近一个月的数据，并把f_create_time、type 添加到联合索引中，提高查询速度。")]),s._v(" "),a("p",[s._v("2.取消工作报告select count(*) 和 分页操作，采用查看更多拉取")]),s._v(" "),a("h3",{attrs:{id:"_3-3-数据库表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-数据库表"}},[s._v("#")]),s._v(" "),a("strong",[s._v("3.3 数据库表")])]),s._v(" "),a("p",[s._v("1.通知数据进行冷热分离，超过一定时间（假设一个月）的通知存放到新的备份表copy中， 根据业务需要，是否开启用户查看历史数据的按钮（也结合create_time），不过数据才240w ，还远不到这个地步。")]),s._v(" "),a("p",[s._v("2.增加数据库配置，磁盘采用更好SSD 固态，提高读写能力, 已跟运维了解当前是本地SSD，性能已很不错")])])}),[],!1,null,null,null);n.default=r.exports}}]);